<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .pagination {
            margin-top: 20px;
        }
        #backButton {
            position: absolute;
            top: 20px;
            left: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <button id="backButton" class="btn btn-primary" onclick="window.location.href='index.html'">Back</button>
        <h2 class="text-center mb-4">User Activity Logs</h2>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <select id="filterActivity" class="form-select">
                    <option value="">All Activities</option>
                    <option value="Search News">News Search</option>
                    <option value="Search Weather">Weather Search</option>
                    <option value="Search Sport">Sport Search</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="date" id="filterDate" class="form-control">
            </div>
            <div class="col-md-4">
                <button id="exportBtn" class="btn btn-success">Export to CSV</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User ID</th>
                        <th>Activity</th>
                        <th>Date/Time</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody"></tbody>
            </table>
        </div>
        
        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
    </div>

    <script>
        let currentPage = 1;
        const recordsPerPage = 15;
        let allLogs = [];

        // Fetch and display logs
        function fetchLogs() {
            fetch('php/record.php', {
                credentials: 'same-origin' // Include cookies for session
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // Handle unauthorized access
                    alert('Please login to view your records');
                    window.location.href = 'login.html';
                    return;
                }
                allLogs = data;
                displayLogs();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching logs. Please try again.');
            });
        }

        // Filter and display logs
        function displayLogs() {
            let filteredLogs = allLogs;
            const tbody = document.getElementById('logsTableBody');
            
            // Apply filters
            const activityFilter = document.getElementById('filterActivity').value;
            const dateFilter = document.getElementById('filterDate').value;
            
            if (activityFilter) {
                filteredLogs = filteredLogs.filter(log => 
                    log.function_name.includes(activityFilter)
                );
            }
            
            if (dateFilter) {
                filteredLogs = filteredLogs.filter(log => 
                    log.access_time.startsWith(dateFilter)
                );
            }

            // Clear previous content
            tbody.innerHTML = '';

            // Check if there are any records after filtering
            if (filteredLogs.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 4; // Span across all columns
                cell.textContent = 'No records found';
                cell.style.textAlign = 'center';
                cell.style.padding = '20px';
                
                // Hide pagination when no records
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // Pagination
            const startIndex = (currentPage - 1) * recordsPerPage;
            const paginatedLogs = filteredLogs.slice(startIndex, startIndex + recordsPerPage);
            
            // Display logs
            paginatedLogs.forEach((log, index) => {
                const row = tbody.insertRow();
                // Calculate the actual record number
                const recordNumber = startIndex + index + 1;
                row.insertCell(0).textContent = recordNumber;
                row.insertCell(1).textContent = log.user_id;
                row.insertCell(2).textContent = log.function_name;
                row.insertCell(3).textContent = new Date(log.access_time).toLocaleString();
            });

            // Update pagination
            updatePagination(filteredLogs.length);
        }

        // Update pagination controls
        function updatePagination(totalRecords) {
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = () => {
                    currentPage = i;
                    displayLogs();
                };
                pagination.appendChild(li);
            }
        }

        // Export to CSV
        document.getElementById('exportBtn').onclick = () => {
            let csv = '#,User ID,Activity,Date/Time\n';
            allLogs.forEach((log, index) => {
                csv += `${index + 1},"${log.user_id}","${log.function_name}","${log.access_time}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activity_logs.csv';
            a.click();
        };

        // Add event listeners for filters
        document.getElementById('filterActivity').onchange = displayLogs;
        document.getElementById('filterDate').onchange = displayLogs;

        // Initial load
        fetchLogs();
    </script>
</body>
</html>